# my convention:
# summary: lower case no period
# description: Upper case and period.


openapi: 3.0.0
info:
  title: WASAPhoto
  description: >
    Keep in touch with your friends
    by sharing photos of special moments,
    thanks to WASAPhoto!

    You can upload your photos directly from your PC,
    and they will be visible to everyone following you.
  version: 0.0.1

tags:
  - name: browsing
    description: All operations realted to users browsing.
  - name: user
    description: All operations realted to users managing theri own profile.
  - name: photo
    description: All operations related to users interacting with a photo.
  - name: login
    description: All operations realted to users logging in.


components:

  schemas:

    UserID:
      description: User identifier.
      type: number
      format: integer
      example: 1
      
    PhotoID:
      description: Photo identifier.
      type: number
      format: integer
      example: 1
    
    CommentID:
      description: Comment identifier.
      type: number
      format: integer
      example: 1

    Username:
      description: Username of a user.
      type: object
      properties:
        name:
          description: Name.
          type: string
          pattern: '^.*?$'
          example: Maria
          minLength: 3
          maxLength: 16
      
    Photo:
      description: This object represents a photo.
      type: object
      properties:
        pid:
          description: Photo ID. 
          $ref: '#/components/schemas/PhotoID'
        uploadDateTime:
          description: Upload date and time.
          type: string
          format: date-time
          example: '2017-07-21T17:32:28Z'
          minLength: 20
          maxLength: 20
        photo:
          description: Photo file.
          type: string
          format: binary
          minLength: 1
          maxLength: 99999999999999999999

    Comment:
      description: This object represents a comment.
      type: object
      properties:
        cid:
          description: Comment ID.
          $ref: '#/components/schemas/CommentID'
        author:
          description: Who has written the comment.
          $ref: '#/components/schemas/UserID'
        uploadDateTime:
          description: Upload date and time.
          type: string
          format: date-time
          example: '2017-07-21T17:32:28Z'
          minLength: 20
          maxLength: 20
        text:
          description: Text of the comment.
          type: string
          pattern: '^.*?$'
          example: Amazing photo!
          minLength: 1
          maxLength: 2200


  parameters:

    UserID:
      name: uid
      in: path
      required: true
      description: User ID.
      schema: { $ref: '#/components/schemas/UserID' }

    UserID2:
      name: uid2
      in: path
      required: true
      description: Second user ID in the path.
      schema: { $ref: '#/components/schemas/UserID' }

    PhotoID:
      name: pid
      in: path
      required: true
      description: Photo ID.
      schema: { $ref: '#/components/schemas/PhotoID' }
    
    CommentID:
      name: cid
      in: path
      required: true
      description: Comment ID
      schema: { $ref: '#/components/schemas/CommentID' }


  responses:
    
    Unauthorized:
      # 401
      description: The client must authenticate itself to get the requested response.
    
    Forbidden:
      # 403
      description: |
        The server understands the request but refuses to authorize it due to one or many of the following possibilities:

        1. the user is trying to act on somebody else's account or
        2. the user is trying to access private information of somebody else's account or
        3. the user is trying to like or comment a photo on behalf of somebody else's account.

        i.e. the ID of the user attempting the request is:
        1. different from the one he wants to edit the account of or
        2. different from the one of the account he wants to retrieve private information of or
        3. different from the one of the account liking or commenting.

        Or simply the user is in the "banned" list of some other user hence is unable to see his profile nor photos.

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer


security:
  - bearerAuth: []


paths:

  /users/{uid}/username:
    parameters:
      - $ref: '#/components/parameters/UserID'

    put:
      operationId: setMyUserName
      tags: [user]
      summary: set personal username
      description: >
        Set personal username with the string provided in the request body.

        The operation is allowed if and only if
        it is the owner of the account to do it.
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Username' }
        required: true
      responses:
        "200":
          # OK
          description: |
            Username successfully updated;
            it is returned in the content.
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Username' }
        "400":
          # Bad Request
          description: >
            The new username is missing from the request body or,
            the new username is not matching the required string pattern.
        "401":
          # Unauthorized
          $ref: '#/components/responses/Unauthorized'
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'


  /users/{uid}/photos/:
    parameters:
      - $ref: '#/components/parameters/UserID'
    
    post:
      operationId: uploadPhoto
      tags: [user]
      summary: upload a new photo on personal account
      description: >
        Upload a new photo on personal account.

        The server will create a new unique ID,
        the client can find it in the response.

        The operation is allowed if and only if
        it is the owner of the account to do it.
      requestBody:
        content:
          multipart/form-data:
            schema: { $ref: '#/components/schemas/Photo' }
            encoding:
              photo:
                contentType: image/png, image/jpeg
        required: true
      responses:
        "201":
          # Created
          description: Photo successfully posted; its ID is in the content.
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PhotoID' }
        "400":
          # Bad Request
          description: >
            The photo is missing from the request body.
        "401":
          # Unauthorized
          $ref: '#/components/responses/Unauthorized'
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'
        "415":
          # Unsupported Media Type
          description: >
            The photo is in a format not supported.


  /users/{uid}/following/{uid2}:
    parameters:
      - $ref: '#/components/parameters/UserID'
      - $ref: '#/components/parameters/UserID2'
    
    put:
      operationId: followUser
      tags: [user]
      summary: start following a user
      description: >
        Add an existing user to the personal 'following' list of users.

        The operation is allowed if and only if
        it is the owner of the account to do it.
      responses:
        "200":
          # OK
          description: |
            User successfully added to the personal 'following' list of users;
            his/her ID is in the content.
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserID' }
        "400":
          # Bad Request
          description: >
            The ID of the user to be added to the 'following' list
            does not match any existing account.
        "401":
          # Unauthorized
          $ref: '#/components/responses/Unauthorized'
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'
    
    delete:
      operationId: unfollowUser
      tags: [user]
      summary: unfollow a user
      description: >
        Remove a user from the personal 'following' list of users.

        The operation is allowed if and only if
        it is the owner of the account to do it.
      responses:
        "200":
          # OK
          description: |
            User successfully removed from the personal 'following' list of users;
            his/her ID is in the content.
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserID' }
        "401":
          # Unauthorized
          $ref: '#/components/responses/Unauthorized'
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'
        "404":
          # Not Found
          description: >
            The server cannot find the requested resource.

            i.e. the ID of the user to be removed from the 'following' list
            is not present in the list.
  

  /users/{uid}/banned/{uid2}:
    parameters:
      - $ref: '#/components/parameters/UserID'
      - $ref: '#/components/parameters/UserID2'
    
    put:
      operationId: banUser
      tags: [user]
      summary: ban a user
      description: >
        Add an existing user to the personal 'banned' list of users.

        The operation is allowed if and only if
        it is the owner of the account to do it.
      responses:
        "200":
          # OK
          description: |
            User successfully added to the personal 'banned' list of users;
            his/her ID is in the content.
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserID' }
        "400":
          # Bad Request
          description: >
            The ID of the user to be added to the 'banned' list
            does not match any existing account.
        "401":
          # Unauthorized
          $ref: '#/components/responses/Unauthorized'
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'
    
    delete:
      operationId: unbanUser
      tags: [user]
      summary: unban a user
      description: >
        Remove a user from the personal 'banned' list of users.

        The operation is allowed if and only if
        it is the owner of the account to do it.
      responses:
        "200":
          # OK
          description: |
            User successfully removed from the personal 'banned' list of users;
            his/her ID is in the content.
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserID' }
        "401":
          # Unauthorized
          $ref: '#/components/responses/Unauthorized'
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'
        "404":
          # Not Found
          description: >
            The server cannot find the requested resource.

            i.e. the ID of the user to be removed from the 'banned' list
            is not present in the list.
  

  /users/:
    
    get:
      operationId: getUserProfile
      tags: [browsing]
      security: [] # no security needed assuming all profiles are private i.e. everyone can visit a profile
      summary: visit the profile page of a user
      description: >
        Visit the profile page of a user (user's photos, followers and following).
        The ID of the user can be specified in the query.
      # ex.
      # /users/?uid=1234
      parameters:
        - name: uid
          in: query
          required: true
          description: User ID of the visited user.
          schema: { $ref: '#/components/schemas/UserID' }
      responses:
        "200":
          # OK
          description: >
            The user profile page (photos, followers and following)
            has been successfully fetched and transmitted in the content.
          content:
            application/json:
              schema:
                type: object
                properties:
                  photos:
                    description: Array of photos.
                    type: array
                    items: { $ref: '#/components/schemas/Photo' }
                    minItems: 0
                    maxItems: 12
                  followers:
                    description: Array of follower users.
                    type: array
                    items: { $ref: '#/components/schemas/UserID' }
                    minItems: 0
                    maxItems: 30
                  following:
                    description: Array of following users.
                    type: array
                    items: { $ref: '#/components/schemas/UserID' }
                    minItems: 0
                    maxItems: 30
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'        
        "404":
          # Not Found
          description: >
            The server cannot find the requested resource.

            i.e. the ID of the user to be visited
            does not match any existing account.
  

  /users/{uid}/stream:
    parameters:
      - $ref: '#/components/parameters/UserID'
    
    get:
      operationId: getMyStream
      tags: [browsing]
      summary: show the personal stream of a user
      description: >
        Each user will be presented with a stream of photos (images)
        in reverse chronological order,
        with information about when each photo was uploaded
        (date and time)
        and how many likes and comments it has.
        The stream is composed by photos from “following”
        (other users that the user follows).

        The operation is allowed if and only if
        it is the owner of the account to do it.
      responses:
        "200":
          # OK
          description: >
            The user personal stream 
            has been successfully fetched and transmitted in the content.
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Photo' }
                minItems: 0
                maxItems: 12
        "401":
          # Unauthorized
          $ref: '#/components/responses/Unauthorized'
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'
  

  /photos/{pid}/likes/{uid}:
    parameters:
      - $ref: '#/components/parameters/PhotoID'
      - $ref: '#/components/parameters/UserID'
    
    put:
      operationId: likePhoto
      tags: [photo]
      summary: put a like to a photo
      description: >
        Put a like to a photo.
        The photo ID can be specified in the path.
        The user ID will be added to the 'likes' collection of that photo.

        The operation is allowed if and only if
        it is the owner of the account to do it.
      responses:
        "204":
          # No Content
          description: |
            The request has succeeded meaning:
            the like has been put to the specified photo and
            the user ID has been added to the 'likes' collection of that photo.
        "401":
          # Unauthorized
          $ref: '#/components/responses/Unauthorized'
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'
        "404":
          # Not Found
          description: >
            The server cannot find the requested resource.

            i.e. the ID of the specified photo
            does not match any existing photo.
    
    delete:
      operationId: unlikePhoto
      tags: [photo]
      summary: delete a like from a photo
      description: >
        Delete a like from a photo.
        The photo ID can be specified in the path.
        The user ID will be deleted from the 'likes' collection of that photo.

        The operation is allowed if and only if
        it is the owner of the account to do it.
      responses:
        "204":
          # No Content
          description: |
            The request has succeeded meaning:
            the like has been deleted from the specified photo and
            the user ID has been deleted from the 'likes' collection of that photo.
        "401":
          # Unauthorized
          $ref: '#/components/responses/Unauthorized'
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'
        "404":
          # Not Found
          description: >
            The server cannot find the requested resource.

            i.e. the ID of the specified photo
            does not match any existing photo.
  

  /photos/{pid}/comments/:
    parameters:
      - $ref: '#/components/parameters/PhotoID'
    
    post:
      operationId: commentPhoto
      tags: [photo]
      summary: comment under a photo
      description: >
        Comment under a photo.
        The photo ID can be specified in the path.
        The comment will be added to the 'comments' list of that photo.
        The server will create a new unique comment ID,
        the client can find it in the response.

        The operation is allowed if and only if
        it is the owner of the account to do it.
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Comment' }
      responses:
        "201":
          # Created
          description: Comment successfully created; its ID is in the content.
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CommentID' }
        "401":
          # Unauthorized
          $ref: '#/components/responses/Unauthorized'
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'
        "404":
          # Not Found
          description: >
            The server cannot find the requested resource.

            i.e. the ID of the specified photo
            does not match any existing photo.
  

  /photos/{pid}/comments/{cid}:
    parameters:
      - $ref: '#/components/parameters/PhotoID'
      - $ref: '#/components/parameters/CommentID'
    
    delete:
      operationId: uncommentPhoto
      tags: [photo]
      summary: delete a comment under a photo
      description: |
        Delete a comment under a photo if and only if it is the author of the comment to do it.
        The photo ID can be specified in the path.
        The comment ID can be specified in the path.
        The comment will be deleted from the 'comments' list of that photo.
      responses:
        "204":
          # No Content
          description: |
            Comment successfully removed from the 'comment' list of specified photo.
        "401":
          # Unauthorized
          $ref: '#/components/responses/Unauthorized'
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'
        "404":
          # Not Found
          description: >
            The server cannot find the requested resource.

            i.e. the ID of the comment to be removed from the 'comment' list
            is not present in the list or,
            the ID of the specified photo does not match any
            existing photo.
  

  /users/{uid}/photos/{pid}:
    parameters:
      - $ref: '#/components/parameters/UserID'
      - $ref: '#/components/parameters/PhotoID'
  
    delete:
      operationId: deletePhoto
      tags: [user]
      summary: delete a photo from personal account
      description: |
        Delete previously uploaded photo.
        The photo ID can be specified in the path.
        The operation is allowed if and only if it is the owner of the account to do it.
      responses:
        "204":
          # No Content
          description: |
            The request has succeeded meaning:
            the photo has been correctly deleted from the account.
        "401":
          # Unauthorized
          $ref: '#/components/responses/Unauthorized'
        "403":
          # Forbidden
          $ref: '#/components/responses/Forbidden'
        "404":
          # Not Found
          description: >
            The server cannot find the requested resource.

            i.e. the ID of the specified photo does not match any
            existing photo.
  

  /session:

    post:
      operationId: doLogin
      tags: [login]
      summary: logs in the user
      description: |-
        If the user does not exist, it will be created,
        and an identifier is returned.
        If the user exists, the user identifier is returned.
      requestBody:
        description: User details.
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Username' }
        required: true
      responses:
        "201":
          # Created
          description: User log-in action successful.
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserID' }